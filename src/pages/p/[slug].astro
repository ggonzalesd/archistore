---
import Layout from '@/layouts/Layout.astro';
import PaypalSvg from '@/components/logos/PaypalSvg.astro';
import MercadoPagoSvg from '@/components/logos/MercadoPagoSvg.astro';
import WaitingButton from '@/components/WaitingButton';
import PaymentButton from '@/components/PaymentButton.astro';
import Price from '@/components/Price.astro';
import PhotoView from '@/components/PhotoView';

import { generateFreeJwtToken } from '@/providers/jwt';
import { supabaseGetProduct } from '@/providers/supabase';
import { AppError, responseError } from '@/utils/app-error';

const { slug } = Astro.params;

let product: Awaited<ReturnType<typeof supabaseGetProduct>> | null = null;
const tokenFree = generateFreeJwtToken(slug ?? '');

try {
  if (!slug) throw AppError.notFound('Product not found').withEncrypted(false);

  product = await supabaseGetProduct(slug);
} catch (e) {
  return responseError(e, Astro);
}
---

<Layout title='Product'>
  <section
    class='container mx-auto grid grid-cols-1 px-2 py-4 pt-20 md:grid-cols-2'
  >
    <div class='flex flex-col items-center justify-center gap-3'>
      <PhotoView
        slug={product.id}
        photos={Math.max(product.photos, 1)}
        client:visible
      />
    </div>
    <div class='flex h-full flex-col gap-2'>
      <h1 class='mb-4 text-4xl text-rose-300'>{product.title}</h1>
      <p class='max-w-[50ch] leading-7'>{product.description}</p>

      <div class='my-4 flex flex-col gap-2'>
        <span class='text-xl text-rose-300'>Price</span>
        <div class='flex items-center gap-4'>
          <Price
            size='LARGE'
            price={product.price}
            discount={product.discount}
          />
        </div>
      </div>

      <div class='my-4 flex gap-4'>
        {
          !(product.price > 0) && (
            <WaitingButton
              href={`/api/storage/${slug}/?free=${tokenFree}`}
              reload={'/p/' + slug}
              time={15}
              maxtime={60 * 5}
              client:visible
            />
          )
        }

        {
          product.price > 0 && (
            <PaymentButton
              href={'/api/payment/paypal?id=' + slug}
              variant='paypal'
            >
              <PaypalSvg class='size-4' />
              <span>Paypal</span>
            </PaymentButton>
            // <PaymentButton href='/api/payment/mercadopago' variant='mercadopago'>
            //   <MercadoPagoSvg class='size-4' />
            //   <span>Mercado Pago</span>
            // </PaymentButton>
          )
        }
      </div>
    </div>
  </section>

  {
    (true || import.meta.env.PROD) && (
      <section class='container mx-auto px-28 py-4'>
        <div class='grid grid-cols-4 gap-2'>
          <div class='aspect-video size-full bg-zinc-500' />
          <div class='aspect-video size-full bg-zinc-500' />
          <div class='aspect-video size-full bg-zinc-500' />
          <div class='aspect-video size-full bg-zinc-500' />
        </div>
      </section>
    )
  }

  <section class='container mx-auto flex justify-center px-2 py-12'>
    {
      !(product.price > 0) && (
        <WaitingButton
          href={`/api/storage/${slug}/?free=${tokenFree}`}
          reload={'/p/' + slug}
          time={15}
          maxtime={60 * 5}
          client:visible
        />
      )
    }
  </section>
</Layout>
